# 📘 **SPECIFICATION.md — テニスコート予約アプリ仕様書（v1.3）**

更新日：2025-12-22

作成者：T Yossy

---

# 1. **概要**

本アプリは、テニスコートの予約管理、参加表明、抽選期間リマインドを行う、
Google Sheets ベースの予約管理ツールである。
Streamlitで構築され、カレンダー形式とリスト形式での表示切り替えが可能で、
チームの調整業務を自動化・簡素化することを目的とする。

---

# 2. **目的**

* テニスコートの予約調整を効率化し、情報の抜け漏れを防ぐ
* チームメンバーの参加状況を一元管理する
* 抽選期間の開始・終了を自動的に案内し、毎月の競争を防ぐ
* 入力補助により、誤記・名称ゆれを防止しメンテナンス性を高める
* Google Drive / Google Sheets を活用し、クラウド環境で安全に管理する

---

# 3. **全体機能一覧**

| 機能カテゴリ       | 内容                                                                        |
| ------------------ | --------------------------------------------------------------------------- |
| 予約管理（CRUD）   | 日付・時間帯・施設名・作成者・メッセージ登録/編集/削除、完了自動化          |
| 参加表明           | 参加/不参加/検討中 の選択、コメント（1件、改行可）、参加者一覧表示          |
| 抽選期間リマインド | 毎月/毎週/毎年 の繰り返し設定、固定文言メッセージ複数登録、トップに常時表示 |
| オートコンプリート | 施設名、ニックネーム候補の入力補助、過去履歴から推奨候補生成                |
| カレンダー表示     | 月間カレンダー、予約状況色分け（確保/抽選中/中止/完了）                     |
| Google Drive 連携  | Sheetsへの読み書き、複数シート（reservations / lottery_periods）管理        |
| 将来拡張予定       | リスト表示（予約一覧＋参加状況）、検索/フィルタ、開発環境＋本番環境分離     |

---

# 4. **データ定義（Google Sheets）**

---

## 4.1 **reservations シート**

| カラム名     | 型           | 内容                             |
| ------------ | ------------ | -------------------------------- |
| date         | date         | 開始日                           |
| facility     | string       | 施設名                           |
| status       | string       | 確保 / 抽選中 / 中止 / 完了      |
| start_hour   | integer      | 開始時（0-23）                   |
| start_minute | integer      | 開始分（0-59）                   |
| end_hour     | integer      | 終了時（0-23）                   |
| end_minute   | integer      | 終了分（0-59）                   |
| participants | list[string] | 参加者一覧（;区切り保存）        |
| absent       | list[string] | 不参加者一覧（;区切り保存）      |
| consider     | list[string] | 検討中一覧（;区切り保存）        |
| message      | string       | メッセージ（改行は`<br>`変換） |

---

## 4.2 **lottery_periods シート（抽選期間リマインド）**

| カラム名    | 型            | 内容                          |
| ----------- | ------------- | ----------------------------- |
| id          | string        | 一意識別子（UUID等）          |
| title       | string        | 抽選・お知らせ内容名          |
| enabled     | string        | 有効フラグ（true/false）      |
| frequency   | string        | monthly / weekly / yearly     |
| start_month | int / null    | yearly：開始月（1-12）        |
| start_day   | int / null    | yearly/monthly：開始日        |
| end_month   | int / null    | yearly：終了月（1-12）        |
| end_day     | int / null    | yearly/monthly：終了日        |
| weekdays    | string / null | weekly：対象曜日（Mon,Thu等） |
| messages    | string        | 表示メッセージ                |

---

# 5. **画面構成**

| 画面エリア               | 内容                                                                                          |
| :----------------------- | :-------------------------------------------------------------------------------------------- |
| **ヘッダー**       | アプリタイトル「🎾 テニスコート予約管理」、抽選期間リマインダー通知                           |
| **メイン表示切替** | **「📅 カレンダー」 / 「📋 予約リスト」 のタブ切り替え**                                |
| **カレンダータブ** | streamlit-calendarによる月表示。日付クリックで新規登録、イベントクリックで編集画面。          |
| **リストタブ**     | DataFrameによる表形式表示。「過去の予約も表示する」チェックボックス付き。行選択で編集画面。   |
| **詳細・編集画面** | **@st.dialogによるポップアップ表示。** 画面遷移なしで登録・編集・削除・参加表明を行う。 |

# 6. **機能詳細仕様**

---

## 6.1 **予約管理（CRUD）**

### ● 新規登録

* 施設名：過去履歴からのselectbox + 新規入力オプション
* ステータス：確保/抽選中/中止から選択（デフォルト：抽選中）
* 時間：time_inputで30分刻み（デフォルト：9:00-11:00）
* メッセージ：text_area（改行は`<br>`に変換して保存）

### ● 編集

* 基本情報表示（日時・施設・ステータス・参加状況・メモ）
* 参加表明：名前選択 + 参加/保留/削除の選択
* 管理者メニュー：メモ編集・ステータス変更・削除機能

### ● 削除

* 管理者メニュー内の削除タブから実行
* DataFrameから該当行を削除してreset_index

---

## 6.2 **参加表明機能**

* 表明は **参加 / 保留 / 削除 の3種**
* 名前は過去履歴からのselectbox + 新規入力オプション
* 各リスト（participants/consider/absent）から重複削除して追加
* 参加者・保留者一覧を「なし」または「, 」区切りで表示

### ● タブ切り替え制御

* タブ切り替え時にlist_reset_counterをインクリメント
* 月移動時も強制リセットでポップアップを閉じる

### ● ポップアップ制御（@st.dialog）

* **フラグ制御:** is_popup_open, popup_mode, last_click_signatureで状態管理
* **重複防止:** 同じクリックでの重複実行を防止
* **CSS調整:** ポップアップの位置・スクロール動作を最適化
* **自動リセット:** 月移動やタブ切り替えで自動的にポップアップを閉じる

## 6.3 **抽選期間リマインド機能**

### ● 表示条件判定

* **enabled列チェック:** "true", "1", "yes", "有効"の場合のみ処理
* **JST時刻:** UTC+9時間で日本時刻に変換
* **条件分岐:**
  * monthly: start_day ≤ 今日の日 ≤ end_day
  * weekly: 今日の曜日が weekdays に含まれる
  * yearly: 年をまたぐ期間も考慮した日付範囲チェック

### ● 表示仕様

* st.info()で "🔔 {メッセージ}" 形式
* 複数該当時は複数表示
* アプリ起動時に自動チェック

## 6.4 **パフォーマンス最適化**

### ● キャッシュ戦略

* **@st.cache_data(ttl=15):** 予約データを15秒キャッシュ
* **@st.cache_data(ttl=3600):** リマインダーデータを1時間キャッシュ
* **@st.cache_resource:** Google Sheets接続をセッション間で共有

### ● リトライ処理

* **run_with_retry関数:** 最大5回リトライ
* **APIエラー対応:** 429/5xx系エラーで指数バックオフ
* **例外処理:** 一般例外は2秒待機後リトライ

---

## 6.5 **入力補助機能**

### ● 施設名補助

* 過去のfacility列から重複除去したリストを生成
* selectboxで "(施設名を選択)" + 過去履歴 + "新規登録" の選択肢
* "新規登録" 選択時にtext_inputを表示

### ● 名前補助

* participants/absent/consider列から全ての名前を収集
* ";" 区切りの文字列も分割して処理
* 重複除去・ソート後にselectboxの選択肢として提供

---

## 6.6 **Google Sheets連携**

### ● 認証方式

* **Service Account認証:** st.secrets["google"]から認証情報取得
* **スコープ:** "https://www.googleapis.com/auth/spreadsheets"
* **接続:** gspread.authorize()でクライアント作成

### ● データ操作

* **読み取り:** get_all_records()で全データ取得
* **書き込み:** clear() + update()で全データ置換
* **データ変換:**
  * リスト → ";" 区切り文字列（保存時）
  * ";" 区切り文字列 → リスト（読み込み時）
  * 日付 → ISO形式文字列（保存時）

---

# 7. **予約ステータスと色定義**

| ステータス | 色 | 説明           |
| ---------- | -- | -------------- |
| 確保       | 緑 | コート確保済み |
| 抽選中     | 黄 | 抽選申請中     |
| 中止       | 赤 | 実施なし       |
| 完了       | 灰 | 過去の予約     |

---

# 8. **UI/UX仕様**

### ● CSS カスタマイズ

* **ポップアップ位置:** 上詰め配置（align-items: flex-start）
* **スクロール制御:** 背景スクロール防止（overscroll-behavior: contain）
* **余白調整:** アプリ全体の上部余白を最小化

### ● レスポンシブ対応

* **スマホ誤操作防止:** longPressDelay: 400ms
* **カラム幅調整:** st.column_configで各列の表示幅を最適化
* **タッチ操作:** streamlit-calendarのタッチイベント対応

---

# 9. **将来拡張**

* 予約一覧のテーブル表示
* 参加状況を一覧化
* 検索＋フィルタ
* Google Calendar 連携
* 開発環境／本番環境の設定切り替え
* バックアップ（複数バージョン保存）

---

# 10. **技術的制約・注意事項**

### ● Google Sheets API制限

* **レート制限:** 100 requests/100 seconds/user
* **対策:** リトライ処理 + キャッシュによる呼び出し削減

### ● データ整合性

* **型変換:** safe_int()関数で安全な数値変換
* **日付処理:** to_jst_date()でタイムゾーン統一
* **リスト処理:** 空文字・None値の適切な処理

### ● セッション状態管理

* **フラグ制御:** is_popup_open, popup_mode等で画面状態を管理
* **重複防止:** last_click_signatureで同一操作の重複実行を防止
* **自動リセット:** 月移動・タブ切り替え時の状態初期化

---

# 11. **更新履歴**

| 日付       | 内容                                                       | 担当    |
| ---------- | ---------------------------------------------------------- | ------- |
| 2025-11-18 | v1.2更新（抽選期間、参加コメント、オートコンプリート統合） | T Yossy |
| 2025-12-22 | v1.3実装に基づく仕様書の正確な更新                         | T Yossy |
